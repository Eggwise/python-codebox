machine:
  services:
    - docker

dependencies:
  override:
    - sed -e "s|<REGISTRY>|$DOCKER_REGISTRY|g" -e "s|<EMAIL>|$DOCKER_EMAIL|g" -e "s|<AUTH>|$DOCKER_AUTH|g" < .dockercfg.template > ~/.dockercfg
    - sed -i 's/CMD/#CMD/g' Dockerfile
    - docker build -t quay.io/syncano/python-codebox .

test:
  override:
    -  if [[ `docker run -it -v \`pwd\`/test.py:/tmp/test.py quay.io/syncano/python-codebox python /tmp/test.py | grep "Error"` ]]; exit 2; fi

deployment:
  production:
    branch:
      - master
    commands:
      - sed -i 's/#CMD/CMD/g' Dockerfile
      - docker build -t quay.io/syncano/python-codebox .
      - docker pull quay.io/syncano/python-codebox
